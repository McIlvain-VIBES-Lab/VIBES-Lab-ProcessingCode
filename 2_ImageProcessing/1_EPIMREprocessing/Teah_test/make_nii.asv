subjects_path = '/Volumes/McIlvainDrive2/Lipton_Soccer_Study/sandbox/2023-U7487-0580-MS-01/';
dirs = dir('2023-*');
dirs = dirs([dirs.isdir]); 

if ~isempty(dirs) 
    movefile(dirs.name, 'NLI_Outputs');
    mkdir('Nifti_Data');
    
    load(fullfile('NLI_Outputs', 'Mu.mat'));
    load(fullfile('NLI_Outputs', 'DR.mat'));
    load('t2stack.mat')
    
    Mu(isnan(Mu)) = 0;
    Mu = single(Mu);
    Mu = flip(flip(permute(Mu, [2 1 3]), 1), 2);
    
    DR(isnan(DR)) = 0;
    DR = single(DR);
    DR = flip(flip(permute(DR, [2 1 3]), 1), 2);

    t2stack(isnan(t2stack)) = 0;
    t2stack = single(t2stack);
    t2stack = flip(flip(permute(t2stack, [2 1 3]), 1), 2);

    Mu_nii = load_nii('t2stack.nii');
    Mu_nii.img = Mu;
    mu_path = fullfile('Nifti_Data','Stiffness.nii');
    save_nii(Mu_nii, mu_path);
    system(['bash process_lipton_mre.sh' mu_path])

    DR_nii = load_nii('t2stack.nii');
    DR_nii.img = DR;
    dr_path = fullfile('Nifti_Data','DampingRatio.nii');
    save_nii(DR_nii, dr_path);
    system(['bash process_lipton_mre.sh', dr_path])

    t2_nii = load_nii('t2stack.nii');
    t2_nii.img = t2stack;
    mag_path = fullfile('Nifti_Data','Magnitude.nii');
    save_nii(t2_nii, mag_path);
    system(['bash process_lipton_mre.sh', mag_path])
end